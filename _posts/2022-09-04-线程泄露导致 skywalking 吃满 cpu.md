---
layout: post
title: 线程泄露导致 skywalking 吃满 cpu
date: 2022-06-27 16:08:25 +0800
last_modified_at: 2022-06-27 16:08:25 +0800
tags: [jvm]
categories: [Blog]
toc:  true
---

## 背景

我们的服务部署在云上，部署了多台 pod，对应的工作负载配置了 k8s 存活探针(走 http 协议)，当 k8s 检测到 pod 中服务不可用时，会自动重启 pod，并通知到开发人员。

## 问题

1. 服务上线后，有时会无缘无故重启，到 pod 上也找不到报错日志，能从 k8s 日志上找到是健康检查没有通过，导致服务重启
2. 服务在稳定运行一段时间后，会变得卡顿，请求超时，导致客户吐槽

## 排查过程

​	在一次值班时，我收到了服务重启通知，分别登录到被重启的 pod (代号 A )和未被重启的 pod (代号B)，A 已经被重启了，问题短时间内肯定不会复现，B没有被重启，并且启动时间和 A 上一次启动时间是一样的，所以 B 很有可能会再次重启，所以在重启前，我们必须定位到问题点。以下是问题排查过程

##### 1. 找到对应的进程，查看进程中线程运行情况

​	使用`top -H -p ${pid}`持续观察线程的运行情况



## 解决方案

描述最终的解决方案
